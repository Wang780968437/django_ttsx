{% extends 'base_top.html' %}

{% block head %}
    <script>
        $(function () {
            var goods_num = 0;
            function total() {
                var total_all = 0;
                var num = 0;
                var checked_num = 0;
                $('.cart_list_td').each(function (i, n) {
                    var price = $(n).children('.col05').children('em').html();
                    var count = $(n).find('.num_show').val();
                    var total_small = price * count;
                    if($(n).children('.col01').children('input').prop('checked')){
                        total_all += total_small;
                        checked_num++;
                    }
                    num++;

                    $('.settlements .col03 em').html(total_all.toFixed(2)+'元');
                    $(n).children('.col07').html(total_small.toFixed(2)+'元')
                    $('.total_count em').html(num);
                    $('.settlements .col03 b').html(checked_num);
                    goods_num = checked_num;
                });
            };

            total();

            $('#check_all').click(function () {
               var check = $(this).prop('checked');
               $(':checkbox:not(#check_all)').prop({'checked':check});
               total();
            });

            $(':checkbox:not(#check_all)').click(function () {
               var len1 = $(':checkbox:not(#check_all)').length;
               var len2 = $(':checked:not(#check_all)').length;
               $('#check_all').prop('checked', len1==len2);
               total();
            });

            $('.add').click(function () {
                var num = parseInt($(this).next().val());
                num++;
                $(this).next().val(num).blur();
                total();
            });

            $('.minus').click(function () {
                var num = parseInt($(this).prev().val());
                num--;
                $(this).prev().val(num).blur();
                total();
            });

            $('.num_show').blur(function () {
                var num = parseInt($(this).val());
                if(isNaN(num) | num<1){
                    num = 1;
                }
                if(num > 100){
                    num = 100;
                }
                $(this).val(num);
                total();

                var cid = $(this).parents('.cart_list_td').prop('id');
                $.get('/cart/edit/', {'count':num, 'cid':cid});
            });

            $('.delete').click(function () {
                var $ul = $(this).parents('.cart_list_td');
                var cid = $ul.prop('id');
                $.get('/cart/delete/',{'cid':cid},function (data) {
                    if(data.ok == 1){
                        $ul.remove();
                        total();
                    }

                });
            });

            $('#sub_form').submit(function () {
                if(goods_num){
                    return true;
                }else {
                    return false;
                }
            });

        });
    </script>

{% endblock head %}


{% block center %}

	<div class="total_count">全部商品<em>0</em>件</div>
	<ul class="cart_list_th clearfix">
		<li class="col01">商品名称</li>
		<li class="col02">商品单位</li>
		<li class="col03">商品价格</li>
		<li class="col04">数量</li>
		<li class="col05">小计</li>
		<li class="col06">操作</li>
	</ul>

    <form action="/order/" method="get" id="sub_form">
    {% for cart in clist %}
	<ul class="cart_list_td clearfix" id="{{ cart.id }}">
		<li class="col01"><input type="checkbox" name="cid" value="{{ cart.id }}" checked="checked"></li>
		<li class="col02"><img src="/static/media/{{ cart.goods.gpic }}"></li>
		<li class="col03">{{ cart.goods.gtitle }}<br><em>{{ cart.goods.gprice }}元/{{ cart.goods.gunit }}</em></li>
		<li class="col04">{{ cart.goods.gunit }}</li>
        <li class="col05"><em>{{ cart.goods.gprice }}</em>元</li>
		<li class="col06">
			<div class="num_add">
				<a href="javascript:;" class="add fl">+</a>
				<input type="text" class="num_show fl" value="{{ cart.count }}">
				<a href="javascript:;" class="minus fl">-</a>
			</div>
		</li>
		<li class="col07">{{ cart.goods.gprice }}元</li>
		<li class="col08"><a href="javascript:;" class="delete">删除</a></li>
	</ul>
    {% endfor %}

	<ul class="settlements">
		<li class="col01"><input type="checkbox" name="" id="check_all" checked="checked"></li>
		<li class="col02">全选</li>
		<li class="col03">合计(不含运费)：<span>¥</span><em>0元</em><br>共计<b>0</b>件商品</li>
		<li class="col04">
            <input type="submit" id="sub_btn" value="去结算">
        </li>
	</ul>
    </form>
{% endblock center %}

